package test;

import com.urlprocess.UrlInfo;
import com.sql.dbutils.Operating;
import com.sql.dbutils.SQL_DBUtil;


import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import java.io.DataInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.PrintWriter;
import java.sql.ResultSet;
import java.sql.SQLException;

import java.util.Map;

public class test implements Servlet {

    @Override
    public void init(ServletConfig servletConfig) throws ServletException {

    }

    @Override
    public ServletConfig getServletConfig() {
        return null;
    }

    @Override
    public void service(ServletRequest servletRequest, ServletResponse servletResponse) throws IOException {
        servletResponse.setContentType("application/json; charset=utf-8");
        HttpServletRequest httpServletRequest = (HttpServletRequest) servletRequest;
        PrintWriter out = servletResponse.getWriter();
        Operating operating = new Operating();
        SQL_DBUtil sql_dbUtil =  new SQL_DBUtil("testone");
        StringBuffer sb = new StringBuffer("{");
        try {
            int i = 0;

            ResultSet rs = operating.db_select(operating.sql_select("account","id,name,password","","",""),sql_dbUtil);
            while (rs.next())
            {
                sb.append("{ \"account\": " + rs.getString(2) + " },");
            //    System.out.println(rs.getString(1) + "," +rs.getString(2)+ "," +rs.getString(3));
                i++;
            }
            rs.close();
        } catch (SQLException e) {
            e.printStackTrace();
        }finally {
            sql_dbUtil.closeConn();
        }
        sb.delete(sb.lastIndexOf(","),sb.length());
        sb.append("}");

        UrlInfo urlInfo = (UrlInfo)servletRequest.getAttribute("urlinfo");
        System.out.println(urlInfo.getRequestURL().toString());

        Map params = (Map) servletRequest.getAttribute("params");

        ///  文件处理
//        String data = get_form_data(httpServletRequest.getInputStream()),d = data.substring(0,data.indexOf("Content-Disposition"));
        //ServletInputStream servletInputStream = httpServletRequest.getInputStream();
//        System.out.println("Size:"+httpServletRequest.getHeader("Content-Length"));
//        System.out.println(httpServletRequest.getContentType());
//        test(httpServletRequest);
//        String[] datas = data.split(d);
//        System.out.println(Arrays.toString(datas));
    //    System.out.println(datas.length);
   //     for(int i = 0;i < datas.length;i++) System.out.println(datas[i]);
      //  System.out.println(httpServletRequest.getHeader("Content-Type"));
//        try {
//       //     Part part=httpServletRequest.getPart("upfile");
//        //    System.out.println(part);
////            String name=part.getHeader("content-disposition");
////                      //System.out.println(name);//测试使用
////            System.out.println(part.getSize());
////            System.out.println(part.getName());
//        } catch (ServletException e) {
//            e.printStackTrace();
//        }


        out.println(sb.toString());
    }

    @Override
    public String getServletInfo() {
        return null;
    }

    @Override
    public void destroy() {

    }
    public void test(HttpServletRequest httpServletRequest) throws IOException {
        String contentType=httpServletRequest.getContentType();
        int start=contentType.indexOf("boundary=");
        int boundaryLen=new String("boundary=").length(),blength = 0;
        int contentLength = httpServletRequest.getContentLength();

        String boundary=contentType.substring(start+boundaryLen);
        boundary="--"+boundary;
        blength = get_Bytelen(boundary);
        System.out.println(boundary);
        byte buffer[] = new byte[contentLength];
        int once = 0;
        int total = 0;
        DataInputStream dataInputStream = new DataInputStream(httpServletRequest.getInputStream());
        while ((total<contentLength) && (once>=0)) {
            once = dataInputStream.read(buffer,total,contentLength);
            total += once;
        }
        System.out.println(total+","+once);
        System.out.println("35a1dw51a1wd6wa1");
    }
    public String get_form_data(InputStream inputStream) throws IOException {
        if(inputStream == null ) return null;
        StringBuffer sb  = new StringBuffer();
        byte[] data  = new byte[1024];
        int hasRead = 0;
        while (0 < (hasRead = inputStream.read(data))){
            sb.append(new String(data,0,hasRead));
        }
        inputStream.close();
      //  System.out.println(sb.toString());
        return sb.toString();
    }

    private static int get_Bytelen(String s){
        return s.getBytes().length;
    }
}
